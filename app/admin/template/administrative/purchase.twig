{% extends "_default/layout.base.twig" %}

{% block content %}

	{% if action == 'edit' %}

		<ol class="breadcrumb">
			<li><a href="/">{% trans "Home" %}</a></li>
			<li><a href="/administrative/purchase">{% trans "Purchases" %}</a></li>
			<li class="active">{% trans "Edit purchase" %}</li>
		</ol>

		{% if errors is defined %}
		<div class="alert alert-danger">
			{% trans "The form contains mistakes. Please correct them." %}
		</div>
		{% elseif env.sticky_session.message is defined %}
			{{ base.display_flash_message(env.sticky_session.message, 'purchase') }}
		{% endif %}

		{% include 'administrative/purchase/modal.document.twig' with {id: 'select-document', modal_size: "lg"} %}

		<form method="post" class="form-horizontal form-condensed" action="/administrative/purchase?action=edit&id={{ purchase.id }}">
		<div class="panel panel-default">
			<div class="panel-heading">{% trans "Purchase details" %}</div>
			<div class="panel-body">
				<div class="form-group">
					<label class="col-xs-3 control-label">{% trans "Supplier" %}</label>
					<div class="col-xs-9">
						<p class="form-control-static">{{ purchase.supplier.company }}</p>
					</div>
				</div>

				<div class="form-group{% if 'document_id' in errors|keys %} has-error{% endif %}">
					<label class="col-xs-3 control-label">
						{% trans "Document" %}
						<a href="#select-document" data-toggle="modal">
							<span class="glyphicon glyphicon-pushpin"></span>
						</a>
					</label>
					<div class="col-xs-9">
						<p class="form-control-static">
							<span id="document_title">
								{% if purchase.document_id > 0 %}
									<a href="/administrative/document?id={{ purchase.document.id }}&action=edit">
										{{ purchase.document.title }}
									</a> [ID: {{ purchase.document.id}}]
								{% else %}
									<em>&lt; {% trans "none selected" %} &gt;</em>
								{% endif %}
							</span>
						</p>
						<input type="hidden" name="purchase[document_id]" value="{{ purchase.document_id }}">
						{{ form.invalid_input('document_id', errors) }}
					</div>
				</div>

				<div class="form-group">
					<label class="col-xs-3 control-label">{% trans "Price excl VAT" %}</label>
					<div class="col-xs-5">
						<div class="input-group">
							<span class="input-group-addon">&euro;</span>
							<input type="text" name="purchase[price_excl]" class="form-control" value="{{ purchase.price_excl }}" >
						</div>
					</div>
				</div>

				<div class="form-group">
					<label class="col-xs-3 control-label">{% trans "Price incl VAT" %}</label>
					<div class="col-xs-5">
						<div class="input-group">
							<span class="input-group-addon">&euro;</span>
							<input type="text" name="purchase[price_incl]" class="form-control" value="{{ purchase.price_incl }}" >
						</div>
					</div>
				</div>

				<div class="form-group{% if 'date' in errors|keys %} has-error{% endif %}">
					<label class="col-xs-3 control-label">{% trans "Date" %}</label>
					<div class="col-xs-5">
						<input type="text" class="form-control datepicker" name="purchase[date]" value="{{ purchase.date }}">
						{{ form.invalid_input('date', errors) }}
					</div>
				</div>

				<div class="form-group{% if 'expiration_date' in errors|keys %} has-error{% endif %}">
					<label class="col-xs-3 control-label">{% trans "Expiration date" %}</label>
					<div class="col-xs-5">
						<input type="text" class="form-control datepicker" name="purchase[expiration_date]" value="{{ purchase.expiration_date }}">
						{{ form.invalid_input('expiration_date', errors) }}
					</div>
				</div>

				<div class="form-group">
					<label class="col-xs-3 control-label">{% trans "Paid date" %}</label>
					<div class="col-xs-5">
						<input type="text" class="form-control datepicker" name="purchase[paid]" value="{{ purchase.paid }}">
					</div>
				</div>

				<div class="form-group">
					<div class="col-xs-9 col-xs-offset-3">
						<button type="submit" class="btn btn-primary">{% trans "Save" %}</button>
					</div>
				</div>

			</div>
		</div>
		</form>

	{% elseif action == 'add' %}

		<ol class="breadcrumb">
			<li><a href="/">{% trans "Home" %}</a></li>
			<li><a href="/administrative/purchase" title="">{% trans "Purchases" %}</a></li>
			<li class="active">{% trans "Create purchase" %}</li>
		</ol>

		{% if errors is defined %}
			<div class="alert alert-danger">
				{% trans "The form contains errors. Please correct them." %}
			</div>
		{% endif %}

		{% include 'administrative/purchase/modal.document.twig' with {id: 'select-document', modal_size: "lg"} %}

		<div class="panel panel-default">
			<div class="panel-heading">
				{% trans "Details" %}
			</div>
			<div class="panel-body">
				<form method="post" action="/administrative/purchase?action=add" class="form-horizontal form-condensed">
					<div class="form-group{% if 'supplier_id' in errors|keys %} has-error{% endif %}">
						<label class="col-xs-3 control-label">{% trans "Supplier" %}</label>
						<div class="col-xs-9">
							<input type="text" id="autocomplete_supplier" name="supplier" class="form-control typeahead" value="{% if purchase is defined and purchase.supplier_id > 0 %}{{ purchase.supplier.company }}{% endif %}" placeholder="{% trans "Search supplier" %}...">
							<input type="hidden" id="supplier_id" name="purchase[supplier_id]" value="{% if purchase is defined and purchase.supplier_id > 0 %}{{ purchase.supplier_id }}{% endif %}">
							{{ form.invalid_input('supplier_id', errors) }}
						</div>
					</div>

					<div class="form-group{% if 'document_id' in errors|keys %} has-error{% endif %}">
						<label class="col-xs-3 control-label">
							{% trans "Document" %}
							<a href="#select-document" data-toggle="modal">
								<span class="glyphicon glyphicon-pushpin"></span>
							</a>
						</label>
						<div class="col-xs-9">
							<p class="form-control-static">
								<span id="document_title">
									{% if purchase is defined and purchase.document_id > 0 %}
										{{ purchase.document.title }}
									{% else %}
										<em>&lt; {% trans "none selected" %} &gt;</em>
									{% endif %}
								</span>
							</p>
							<input type="hidden" name="purchase[document_id]" value="{{ purchase.document_id }}">
							{{ form.invalid_input('document_id', errors) }}
						</div>
					</div>

					<div class="form-group{% if 'price_excl' in errors|keys %} has-error{% endif %}">
						<label class="col-xs-3 control-label">{% trans "Price (excl)" %}</label>
						<div class="col-xs-5">
							<div class="input-group">
								<span class="input-group-addon">&euro;</span>
								<input type="text" class="form-control" name="purchase[price_excl]" value="{{ purchase.price_excl }}">
							</div>
							{{ form.invalid_input('price_excl', errors) }}
						</div>
					</div>

					<div class="form-group{% if 'price_incl' in errors|keys %} has-error{% endif %}">
						<label class="col-xs-3 control-label">{% trans "Price (incl)" %}</label>
						<div class="col-xs-5">
							<div class="input-group">
								<span class="input-group-addon">&euro;</span>
								<input type="text" class="form-control" name="purchase[price_incl]" value="{{ purchase.price_incl }}">
							</div>
							{{ form.invalid_input('price_incl', errors) }}
						</div>
					</div>

					<div class="form-group{% if 'date' in errors|keys %} has-error{% endif %}">
						<label class="col-xs-3 control-label">{% trans "Date" %}</label>
						<div class="col-xs-5">
							<input type="text" class="form-control datepicker" name="purchase[date]" value="{{ purchase.date }}">
							{{ form.invalid_input('date', errors) }}
						</div>
					</div>

					<div class="form-group{% if 'expiration_date' in errors|keys %} has-error{% endif %}">
						<label class="col-xs-3 control-label">{% trans "Expiration date" %}</label>
						<div class="col-xs-5">
							<input type="text" class="form-control datepicker" name="purchase[expiration_date]" value="{{ purchase.expiration_date }}">
							{{ form.invalid_input('expiration_date', errors) }}
						</div>
					</div>

					<div class="form-group">
						<label class="col-xs-3 control-label">{% trans "Paid date" %}</label>
						<div class="col-xs-5">
							<input type="text" class="form-control datepicker" name="purchase[paid]" value="{{ purchase.paid }}">
						</div>
					</div>

					<div class="form-group">
						<div class="col-xs-3 col-xs-offset-3">
							<button class="btn btn-primary">
								{% trans "Save" %}
							</button>
						</div>
					</div>
				</form>
			</div>
		</div>

	{% else %}

		<ol class="breadcrumb">
			<li><a href="/">{% trans "Home" %}</a></li>
			<li class="active">{% trans "Purchases" %}</li>
		</ol>

		<div class="panel panel-default">
			<div class="panel-heading">
				{% trans "Filter" %}
			</div>
			<div class="panel-body">
				<form method="post" action="/administrative/purchase" class="form-horizontal">
					<div class="form-group">
						<label class="col-xs-3 control-label">{% trans "Search" %}</label>
						<div class="col-xs-9">
							<input type="text" name="search" class="form-control" value="{{ pager.get_search() }}">
						</div>
					</div>
					<div class="form-group">
						<div class="col-xs-3 col-xs-offset-3">
							<button class="btn btn-primary">
								{% trans "Search" %}
							</button>
						</div>
					</div>
				</form>
			</div>
		</div>

		{% if env.sticky_session.message is defined %}
			{{ base.display_flash_message(env.sticky_session.message, 'purchase') }}
		{% endif %}

		<div class="panel panel-default">
			<div class="panel-heading">
				<div class="pull-right">
					<a href="/administrative/purchase?action=add" title="">
						<span class="glyphicon glyphicon-plus-sign"></span>
						{% trans "Add purchase" %}
					</a>
				</div>
				{{ base.pager_count(pager.item_count) }}
			</div>
			<div class="panel-body">
			{% for purchase in pager.items %}
			{% if loop.first %}
				<table class="table table-hover table-striped table-condensed table-responsive" id="purchase-list">
				<thead>
					<tr>
						<th width="10%">{{ pager.create_header('Number'|trans, 'id')|raw }}</th>
						<th width="15%">{{ pager.create_header('Expiration date'|trans, 'expiration_date')|raw }}</th>
						<th width="35%">{{ pager.create_header('Supplier'|trans, 'supplier.company')|raw }}</th>
						<th width="20%" class="text-right">{{ pager.create_header('Price incl'|trans, 'price_incl')|raw }}</th>
						<th width="10%">{{ pager.create_header('Paid'|trans, 'paid')|raw }}</th>
						<th style="width: 10%" colspan="3">&nbsp;</th>
					</tr>
				</thead>
				<tbody>
			{% endif %}

				<tr>
					<td>{{ purchase.id }}</td>
					<td>{{ purchase.expiratione_date|date }}</td>
					<td>{{ purchase.supplier.company }}</td>
					<td class="text-right">€{{ purchase.price_incl|number_format }}</td>
					<td>
					{% if not purchase.paid is empty %}
						<span class="glyphicon glyphicon-ok" title="{{ purchase.paid|datetime }}"></span>
					{% else %}
						<span class="glyphicon glyphicon-remove"></span>
					{% endif %}
					</td>
					<td>
						<a href="/administrative/purchase?action=download&id={{ purchase.id }}">
							<span class="glyphicon glyphicon-download"></span>
						</a>
					</td>
					<td class="text-right">
						<a href="/administrative/purchase?action=edit&id={{ purchase.id }}" title="">
							<span class="glyphicon glyphicon-pencil"></span>
						</a>
					</td>
					<td>
						<a href="/administrative/purchase?action=delete&id={{ purchase.id }}" data-confirm-title="{% trans "Please confirm" %}" data-confirm-message="{% trans "Are you sure you want to delete this purchase?" %}">
							<span class="glyphicon glyphicon-trash"></span>
						</a>
					</td>
				</tr>

			{% if loop.last %}
				</tbody>
				</table>

				{{ pager.links|raw }}
			{% endif %}

			{% else %}

				<p><em>{% trans "No purchases found." %}</em></p>

			{% endfor %}
			</div>
		</div>

	{% endif %}

{% endblock content %}

{% block javascript %}

	<script type="text/javascript" src="/bloodhound.min.js"></script>
	<script type="text/javascript" src="/typeahead.min.js"></script>
	<script type="text/javascript">

		var suppliers = new Bloodhound({
			datumTokenizer: Bloodhound.tokenizers.obj.whitespace('value'),
			queryTokenizer: Bloodhound.tokenizers.whitespace,
			remote: '/administrative/supplier?action=ajax_search&search=%QUERY'
		});

		suppliers.initialize();

		$('#autocomplete_supplier').typeahead({
			hint: true,
			highlight: true,
			minLength: 2
		},{
			name:	'supplier',
			displayKey: 'value',
			source:	suppliers.ttAdapter()
		});
		$('#autocomplete_supplier').on('typeahead:selected typeahead:autocompleted', function(e,data) {
			$('#supplier_id').val(data.id);
		});
	</script>

{% endblock javascript %}

{% block head %}

	<link rel="stylesheet" type="text/css" href="/typeahead.css">
	<link rel="stylesheet" type="text/css" href="/bootstrap-tokenfield.min.css">

{% endblock head %}
